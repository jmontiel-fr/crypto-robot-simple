<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Robot Dashboard - Simple</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Force no caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        .status-card {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        .frozen-card {
            border-left: 4px solid #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }
        .btn-action {
            margin: 5px;
        }
        .dashboard-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 10px;
        }
        .status-badge {
            font-size: 0.9em;
            padding: 8px 12px;
        }
        .last-update {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 5px;
        }
        .connection-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.8em;
        }
        .menu-section {
            margin-bottom: 25px;
        }
        .menu-title {
            color: #495057;
            font-weight: bold;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid #007bff;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            border: none;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
        }
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            border: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: none;
        }
        
        /* Debug collapse animations */
        .debug-toggle-btn {
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            padding: 0.5rem 0;
        }
        .debug-toggle-btn:focus {
            outline: none;
            box-shadow: none;
        }
        .debug-toggle-btn .fa-chevron-down {
            transition: transform 0.3s ease;
        }
        .debug-toggle-btn[aria-expanded="true"] .fa-chevron-down {
            transform: rotate(180deg);
        }
        
        /* Configuration display styling */
        #robot-config, #trading-config, #system-config, #database-config {
            font-size: 0.9em;
            line-height: 1.6;
        }
        
        .config-section h6 {
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 0.25rem;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Connection Status Indicator -->
    <div class="connection-indicator">
        <div id="connection-status" class="badge bg-warning">
            <i class="fas fa-circle"></i>
            <span>HTTP Only</span>
        </div>
    </div>

    <div class="container mt-4">
        <div class="dashboard-title text-center">
            <h1><i class="fas fa-robot"></i> Crypto Trading Robot Dashboard</h1>
            <p class="mb-0">Automated Portfolio Management - Simplified Version</p>
        </div>

        <!-- Debug Information -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <button class="btn btn-sm btn-outline-secondary debug-toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#debugCollapse" aria-expanded="false" aria-controls="debugCollapse">
                            <i class="fas fa-bug"></i> Debug Information
                            <i class="fas fa-chevron-down ms-2"></i>
                        </button>
                    </div>
                    <div class="collapse" id="debugCollapse">
                        <div class="card-body">
                            <div class="debug-info" id="debug-info">
                                Page loaded at: <span id="page-load-time"></span><br>
                                Last API call: <span id="last-api-call">None</span><br>
                                Load attempts: <span id="load-attempts">0</span><br>
                                Status: <span id="debug-status">Initializing...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration Information -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <button class="btn btn-sm btn-outline-info debug-toggle-btn" type="button" data-bs-toggle="collapse" data-bs-target="#configCollapse" aria-expanded="false" aria-controls="configCollapse">
                            <i class="fas fa-cog"></i> Configuration Parameters
                            <i class="fas fa-chevron-down ms-2"></i>
                        </button>
                    </div>
                    <div class="collapse" id="configCollapse">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-robot"></i> Robot Settings</h6>
                                    <div class="debug-info" id="robot-config">
                                        Loading robot configuration...
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chart-line"></i> Trading Settings</h6>
                                    <div class="debug-info" id="trading-config">
                                        Loading trading configuration...
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-server"></i> System Settings</h6>
                                    <div class="debug-info" id="system-config">
                                        Loading system configuration...
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-database"></i> Database Settings</h6>
                                    <div class="debug-info" id="database-config">
                                        Loading database configuration...
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshConfiguration()">
                                        <i class="fas fa-sync-alt"></i> Refresh Configuration
                                    </button>
                                    <small class="text-muted ms-2">
                                        <i class="fas fa-shield-alt"></i> Secret keys are hidden for security
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card" id="status-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-heartbeat"></i> Robot Status</h5>
                        <div>
                            <span id="status-badge" class="badge bg-secondary">Loading...</span>
                            <div class="last-update" id="last-update">Never updated</div>
                        </div>
                    </div>
                    <div class="card-body" id="status-content">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Starting simple HTTP load...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Summary -->
        <div class="row mb-4" id="portfolio-summary">
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Current Cycle</h5>
                        <h3 id="current-cycle">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">{{ base_asset }} Reserve</h5>
                        <h3 id="bnb-reserve">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-info">Portfolio Value</h5>
                        <h3 id="portfolio-value">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">Total Value</h5>
                        <h3 id="total-value">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center" id="mode-card">
                    <div class="card-body">
                        <h5 class="card-title" id="mode-title">Trading Mode</h5>
                        <h3 id="trading-mode">-</h3>
                        <small class="text-muted" id="mode-description">Loading...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs"></i> Robot Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <button type="button" class="btn btn-primary btn-action" onclick="refreshStatus()">
                                <i class="fas fa-sync"></i> Refresh Status
                            </button>
                            <button type="button" class="btn btn-info btn-action" onclick="validateBalance()">
                                <i class="fas fa-wallet"></i> Check Balance
                            </button>
                            <button type="button" class="btn btn-success btn-action" id="manual-cycle-btn" onclick="manualCycle()" 
                                    title="Execute immediate trading cycle - perfect for testing rebalancing in dry-run mode">
                                <i class="fas fa-play"></i> Manual Cycle
                            </button>
                            <button type="button" class="btn btn-danger btn-action" onclick="freezeRobot()" id="freeze-btn">
                                <i class="fas fa-pause"></i> Freeze Robot
                            </button>
                            <button type="button" class="btn btn-warning btn-action" onclick="unfreezeRobot()" id="unfreeze-btn" style="display:none;">
                                <i class="fas fa-unlock"></i> Unfreeze Robot
                            </button>
                            <button type="button" class="btn btn-info btn-action" onclick="showExtractModal()">
                                <i class="fas fa-money-bill-wave"></i> Extract EUR
                            </button>
                            <button type="button" class="btn btn-success btn-action" onclick="showInjectModal()">
                                <i class="fas fa-plus-circle"></i> Inject USDC
                            </button>
                            <button type="button" class="btn btn-danger btn-action" onclick="showClosePortfolioModal()">
                                <i class="fas fa-times-circle"></i> Close Portfolio
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Strategy -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Trading Strategy</h5>
                    </div>
                    <div class="card-body">
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="card border-warning">
                                    <div class="card-body text-center">
                                        <h4 class="card-title text-warning">
                                            <i class="fas fa-sync-alt"></i> Daily Rebalance Strategy
                                        </h4>
                                        <p class="card-text lead">High-performance strategy with 10 optimized cryptocurrencies</p>
                                        <div class="mb-3">
                                            <span class="badge bg-danger fs-6">High Risk</span>
                                            <span class="badge bg-warning fs-6">Daily Cycles</span>
                                            <span class="badge bg-success fs-6">1000-2500% Monthly Return</span>
                                        </div>
                                        <div class="row text-start mb-3">
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-coins"></i> Assets</h6>
                                                <p class="small">10 optimized cryptocurrencies</p>
                                            </div>
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-clock"></i> Frequency</h6>
                                                <p class="small">Daily rebalancing (1440 minutes)</p>
                                            </div>
                                        </div>
                                        <a href="/daily-rebalance" class="btn btn-warning btn-lg">
                                            <i class="fas fa-rocket"></i> Open Strategy Dashboard
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Extract Modal -->
        <div class="modal fade" id="extractModal" tabindex="-1" aria-labelledby="extractModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="extractModalLabel">
                            <i class="fas fa-money-bill-wave"></i> Extract EUR from Portfolio
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Extract Operation:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Sells proportional amounts from all 10 crypto positions</li>
                                <li>Converts the proceeds to USDC</li>
                                <li>Preserves your {{ base_asset }} reserve</li>
                                <li>Temporarily freezes trading during operation</li>
                            </ul>
                        </div>
                        
                        <form id="extractForm">
                            <div class="mb-3">
                                <label for="eurAmount" class="form-label">EUR Amount to Extract:</label>
                                <div class="input-group">
                                    <span class="input-group-text">‚Ç¨</span>
                                    <input type="number" class="form-control" id="eurAmount" 
                                           placeholder="100.00" step="0.01" min="1" required>
                                </div>
                                <div class="form-text">
                                    Enter the amount in EUR you want to extract from your portfolio.
                                </div>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="dryRun" checked>
                                <label class="form-check-label" for="dryRun">
                                    Dry Run (Simulation Only)
                                </label>
                                <div class="form-text">
                                    Recommended: Test the operation first without executing actual trades.
                                </div>
                            </div>
                        </form>
                        
                        <div id="extractResult" class="alert" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="executeExtract()" id="extractBtn">
                            <i class="fas fa-play"></i> Execute Extract
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inject Modal -->
        <div class="modal fade" id="injectModal" tabindex="-1" aria-labelledby="injectModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="injectModalLabel">
                            <i class="fas fa-plus-circle"></i> Inject USDC into Portfolio
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> How Inject Works:</h6>
                            <ul class="mb-0">
                                <li>Converts your USDC to cryptocurrencies</li>
                                <li>Distributes proportionally across existing positions</li>
                                <li>Maintains your current portfolio allocation</li>
                                <li>Temporarily freezes trading during operation</li>
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <label class="form-label">Available USDC Balance:</label>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshUsdcBalance()">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="input-group">
                                <span class="input-group-text">üí∞</span>
                                <input type="text" class="form-control" id="usdcBalance" readonly 
                                       placeholder="Loading..." style="background-color: #f8f9fa;">
                            </div>
                        </div>
                        
                        <form id="injectForm">
                            <div class="mb-3">
                                <label for="usdcAmount" class="form-label">USDC Amount to Inject:</label>
                                <div class="input-group">
                                    <span class="input-group-text">USDC</span>
                                    <input type="number" class="form-control" id="usdcAmount" 
                                           placeholder="100.00" step="0.01" min="1" required>
                                </div>
                                <div class="form-text">
                                    Enter the amount in USDC you want to inject into your portfolio.
                                </div>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="injectDryRun" checked>
                                <label class="form-check-label" for="injectDryRun">
                                    Dry Run (Simulation Only)
                                </label>
                                <div class="form-text">
                                    Recommended: Test the operation first without executing actual trades.
                                </div>
                            </div>
                        </form>
                        
                        <div id="injectResult" class="alert" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="executeInject()" id="injectBtn">
                            <i class="fas fa-play"></i> Execute Inject
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Close Portfolio Modal -->
        <div class="modal fade" id="closePortfolioModal" tabindex="-1" aria-labelledby="closePortfolioModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="closePortfolioModalLabel">
                            <i class="fas fa-times-circle"></i> Close Portfolio
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>WARNING: Portfolio Closure</strong>
                            <p class="mb-0 mt-2">This operation will completely liquidate your portfolio:</p>
                            <ul class="mb-0 mt-2">
                                <li><strong>Freeze the robot</strong> to stop all trading activity</li>
                                <li><strong>Sell 100% of all cryptocurrency positions</strong> to USDC</li>
                                <li><strong>Convert {{ base_asset }} reserve</strong> to USDC (except transaction fees)</li>
                                <li><strong>Clear all portfolio data</strong> from the database</li>
                                <li><strong>Option to restart</strong> with a fresh portfolio and new {{ base_asset }} reserve</li>
                            </ul>
                        </div>
                        
                        <form id="closePortfolioForm">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="confirmLiquidation" required>
                                    <label class="form-check-label text-danger fw-bold" for="confirmLiquidation">
                                        I understand this will liquidate my entire portfolio
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="enableReset">
                                    <label class="form-check-label" for="enableReset">
                                        Reset portfolio and restart robot with new reserve
                                    </label>
                                </div>
                            </div>
                            
                            <div id="resetOptions" style="display: none;">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-refresh"></i> Reset Options</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="newReserveAmount" class="form-label">New {{ base_asset }} Reserve Amount:</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="newReserveAmount" 
                                                       placeholder="0.1" step="0.001" min="0.01" max="10">
                                                <span class="input-group-text">{{ base_asset }}</span>
                                            </div>
                                            <div class="form-text">
                                                Amount of {{ base_asset }} to keep as reserve for the new trading cycle (minimum 0.01 {{ base_asset }}).
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="autoStart">
                                                <label class="form-check-label" for="autoStart">
                                                    Automatically start robot after reset
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="dryRunClose" checked>
                                <label class="form-check-label" for="dryRunClose">
                                    Dry Run (Simulation Only)
                                </label>
                                <div class="form-text">
                                    Recommended: Test the operation first without executing actual trades.
                                </div>
                            </div>
                        </form>
                        
                        <div id="closePortfolioResult" class="alert" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="executeClosePortfolio()" id="closePortfolioBtn">
                            <i class="fas fa-times-circle"></i> Close Portfolio
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Menu -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-th-large"></i> Dashboard Menu</h5>
                    </div>
                    <div class="card-body">
                        <!-- Historical Data Section -->
                        <div class="menu-section">
                            <h6 class="menu-title"><i class="fas fa-chart-line"></i> Historical Data & Analytics</h6>
                            <div class="row">
                                <div class="col-md-3 mb-2">
                                    <a href="/portfolio-history" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-chart-area"></i> Portfolio History
                                    </a>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <a href="/reserve-history" class="btn btn-success btn-lg w-100">
                                        <i class="fas fa-piggy-bank"></i> Reserve History
                                    </a>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <a href="/combined-history" class="btn btn-info btn-lg w-100">
                                        <i class="fas fa-chart-pie"></i> Combined View
                                    </a>
                                </div>
                                <div class="col-md-3 mb-2">
                                    <a href="{{ url_for('simulator_list') }}" class="btn btn-warning btn-lg w-100">
                                        <i class="fas fa-flask"></i> Simulator
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Binance Integration Section -->
                        <div class="menu-section">
                            <h6 class="menu-title"><i class="fab fa-bitcoin"></i> Binance Integration</h6>
                            <div class="row">
                                <div class="col-md-4 mb-2">
                                    <a href="/binance-account" class="btn btn-secondary btn-lg w-100">
                                        <i class="fas fa-user"></i> Account Info
                                    </a>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <a href="/binance-transactions" class="btn btn-secondary btn-lg w-100">
                                        <i class="fas fa-exchange-alt"></i> Transaction History
                                    </a>
                                </div>
                                <div class="col-md-4 mb-2">
                                    <a href="/binance-account?live_prices=true" class="btn btn-secondary btn-lg w-100">
                                        <i class="fas fa-chart-candlestick"></i> Live Prices
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const BASE_ASSET = "{{ base_asset }}";
        // Global variables
        let loadAttempts = 0;
        let lastSuccessfulLoad = null;

        // Update connection status indicator based on protocol
        function updateConnectionStatus() {
            const connectionStatus = document.getElementById('connection-status');
            if (window.location.protocol === 'https:') {
                connectionStatus.className = 'badge bg-success';
                connectionStatus.innerHTML = '<i class="fas fa-lock"></i> <span>HTTPS Secure</span>';
            } else {
                connectionStatus.className = 'badge bg-warning';
                connectionStatus.innerHTML = '<i class="fas fa-circle"></i> <span>HTTP Only</span>';
            }
        }

        // Initialize on page load
        updateConnectionStatus();

        // Initialize debug info
        document.getElementById('page-load-time').textContent = new Date().toLocaleString();
        
        // Helper: try multiple URL candidates (relative and absolute) and return first OK
        async function fetchWithFallback(paths) {
            let lastErr = null;
            for (const p of paths) {
                try {
                    console.log('Trying status URL:', p);
                    const resp = await fetch(p);
                    if (resp.ok) return { url: p, resp };
                    lastErr = new Error(`HTTP ${resp.status}: ${resp.statusText}`);
                } catch (e) {
                    lastErr = e;
                }
            }
            throw lastErr || new Error('All status endpoints failed');
        }

        // Simple refresh function with detailed logging
        async function refreshStatus() {
            loadAttempts++;
            document.getElementById('load-attempts').textContent = loadAttempts;
            document.getElementById('debug-status').textContent = 'Loading...';
            document.getElementById('last-api-call').textContent = new Date().toLocaleString();
            
            console.log('=== REFRESH STATUS CALLED ===');
            console.log('Attempt #:', loadAttempts);
            
            // Update UI to show loading
            const protocol = window.location.protocol === 'https:' ? 'HTTPS' : 'HTTP';
            document.getElementById('status-content').innerHTML = 
                `<div class="text-center"><div class="spinner-border text-info" role="status"></div><p class="mt-2">Loading data via ${protocol}...</p></div>`;
            
            try {
                const candidates = [
                    'api/status',
                    'status',
                    '/api/status',
                    '/status',
                ];
                const { url, resp } = await fetchWithFallback(candidates);
                console.log('Response received from:', url, resp.status, resp.statusText);
                document.getElementById('debug-status').textContent = `Response: ${resp.status} (${url})`;
                const data = await resp.json();
                console.log('Data received:', data);
                document.getElementById('debug-status').textContent = 'Success - Data loaded';
                lastSuccessfulLoad = new Date();
                updateStatusDisplay(data);
                updateLastUpdateTime();
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('debug-status').textContent = `Error: ${error.message}`;
                document.getElementById('status-content').innerHTML = 
                    `<div class="alert alert-danger">
                        <h6>Failed to load data</h6>
                        <p>Error: ${error.message}</p>
                        <div class="mt-2">
                            <a class="btn btn-sm btn-outline-secondary" href="/routes" target="_blank">View Registered Routes</a>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="refreshStatus()">Try Again</button>
                        </div>
                    </div>`;
            }
        }

        function updateStatusDisplay(data) {
            console.log('Updating display with data:', data);
            
            const statusCard = document.getElementById('status-card');
            const statusContent = document.getElementById('status-content');
            const statusBadge = document.getElementById('status-badge');
            const unfreezeBtn = document.getElementById('unfreeze-btn');
            const freezeBtn = document.getElementById('freeze-btn');

            // Create dry-run mode indicator
            const dryRunIndicator = data.dry_run_mode ? 
                `<div class="alert alert-warning mt-2 mb-0">
                    <i class="fas fa-flask"></i> <strong>DRY-RUN MODE:</strong> Robot is simulating trades without real money
                </div>` : 
                `<div class="alert alert-info mt-2 mb-0">
                    <i class="fas fa-dollar-sign"></i> <strong>LIVE MODE:</strong> Robot is trading with real money
                </div>`;

            if (data.is_frozen) {
                statusCard.className = 'card frozen-card';
                statusBadge.className = 'badge bg-danger';
                statusBadge.innerHTML = '<i class="fas fa-pause"></i> FROZEN';
                
                statusContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Robot is Frozen</h5>
                        <p>${data.freeze_reason || 'No reason specified'}</p>
                        ${data.cycles_suspended > 0 ? `<p><strong>Cycles Suspended:</strong> ${data.cycles_suspended}</p>` : ''}
                    </div>
                    ${dryRunIndicator}
                `;
                unfreezeBtn.style.display = 'inline-block';
                freezeBtn.style.display = 'none';
            } else if (data.current_cycle > 0 || data.last_cycle_time) {
                // Robot has been running (has cycle data)
                statusCard.className = 'card status-card';
                statusBadge.className = 'badge bg-success';
                statusBadge.innerHTML = '<i class="fas fa-play"></i> RUNNING';
                
                statusContent.innerHTML = `
                    <div class="alert alert-success">
                        <h5>Robot is Active</h5>
                        <p>Trading cycles are operational</p>
                        <p><strong>Last cycle:</strong> ${data.last_cycle_time ? new Date(data.last_cycle_time).toLocaleString() : 'Never'}</p>
                    </div>
                    ${dryRunIndicator}
                `;
                unfreezeBtn.style.display = 'none';
                freezeBtn.style.display = 'inline-block';
            } else {
                // Robot has never been started
                statusCard.className = 'card';
                statusBadge.className = 'badge bg-secondary';
                statusBadge.innerHTML = '<i class="fas fa-stop"></i> NOT STARTED';
                
                statusContent.innerHTML = `
                    <div class="alert alert-info">
                        <h5>Robot is Ready</h5>
                        <p>Robot has not been started yet. Use the manual cycle or start the robot to begin trading.</p>
                        <p><strong>Status:</strong> Waiting for first cycle</p>
                    </div>
                    ${dryRunIndicator}
                `;
                unfreezeBtn.style.display = 'none';
                freezeBtn.style.display = 'none';
            }

            // Update summary cards
            document.getElementById('current-cycle').textContent = data.current_cycle || 0;
            // current_trade removed
            document.getElementById('bnb-reserve').textContent = (data.bnb_reserve || 0).toFixed(6) + ` ${BASE_ASSET}`;
            document.getElementById('portfolio-value').textContent = (data.portfolio_value || 0).toFixed(6);
            document.getElementById('total-value').textContent = (data.total_value || 0).toFixed(6);
            
            // Update trading mode card
            const modeCard = document.getElementById('mode-card');
            const modeTitle = document.getElementById('mode-title');
            const tradingMode = document.getElementById('trading-mode');
            const modeDescription = document.getElementById('mode-description');
            
            if (data.dry_run_mode) {
                modeCard.className = 'card text-center border-warning';
                modeTitle.className = 'card-title text-warning';
                tradingMode.innerHTML = '<i class="fas fa-flask"></i> DRY-RUN';
                modeDescription.textContent = 'Simulating trades without real money';
            } else {
                modeCard.className = 'card text-center border-success';
                modeTitle.className = 'card-title text-success';
                tradingMode.innerHTML = '<i class="fas fa-dollar-sign"></i> LIVE';
                modeDescription.textContent = 'Trading with real money';
            }
            
            // Update manual cycle button based on mode
            const manualCycleBtn = document.getElementById('manual-cycle-btn');
            if (data.dry_run_mode) {
                manualCycleBtn.className = 'btn btn-success btn-action';
                manualCycleBtn.title = 'Execute immediate trading cycle - perfect for testing rebalancing in dry-run mode';
                manualCycleBtn.innerHTML = '<i class="fas fa-play"></i> Manual Cycle';
            } else {
                manualCycleBtn.className = 'btn btn-secondary btn-action';
                manualCycleBtn.title = 'Manual cycle is only available in dry-run mode. Set ROBOT_DRY_RUN=true to enable testing.';
                manualCycleBtn.innerHTML = '<i class="fas fa-lock"></i> Manual Cycle (Dry-Run Only)';
            }
            
            // Store current status for use in other functions
            window.currentStatus = data;
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = `Last update: ${now.toLocaleTimeString()}`;
        }

        // Action functions
        function manualCycle() {
            // Check if we're in dry-run mode for better messaging
            const isDryRun = window.currentStatus && window.currentStatus.dry_run_mode;
            
            if (!isDryRun) {
                // Show informative popup for live mode
                alert('‚ö†Ô∏è Manual Cycle - Live Mode Limitation\n\n' +
                      'Manual cycle is currently only operational in DRY-RUN mode.\n\n' +
                      'Why?\n' +
                      '‚Ä¢ Safe testing without real money risk\n' +
                      '‚Ä¢ Immediate feedback for strategy validation\n' +
                      '‚Ä¢ No need for separate robot process\n\n' +
                      'To use manual cycle:\n' +
                      '1. Set ROBOT_DRY_RUN=true in your .env file\n' +
                      '2. Restart the web app\n' +
                      '3. Click Manual Cycle to test rebalancing\n\n' +
                      'For live trading, use the main robot process (enhanced_crypto_robot.py)');
                return;
            }
            
            const message = 'Execute a manual dry-run trading cycle?\n\nThis will:\n‚Ä¢ Analyze current market conditions\n‚Ä¢ Execute rebalancing strategy\n‚Ä¢ Update virtual portfolio\n‚Ä¢ Perfect for testing without waiting for cycle timer!';
            
            if (confirm(message)) {
                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing...';
                button.disabled = true;
                
                fetch('api/manual-cycle', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            let message = 'Manual cycle executed successfully!';
                            if (data.actions_taken && data.actions_taken.length > 0) {
                                message += '\n\nActions taken:\n' + data.actions_taken.join('\n');
                            }
                            alert(message);
                            refreshStatus();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    })
                    .finally(() => {
                        // Restore button state
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
            }
        }

        function freezeRobot() {
            if (confirm('Freeze the robot?')) {
                fetch('api/freeze', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.success ? 'Robot frozen!' : 'Error: ' + data.error);
                        if (data.success) refreshStatus();
                    })
                    .catch(error => alert('Error: ' + error.message));
            }
        }

        function unfreezeRobot() {
            if (confirm('Unfreeze the robot?')) {
                fetch('api/unfreeze', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.success ? 'Robot unfrozen!' : 'Error: ' + data.error);
                        if (data.success) refreshStatus();
                    })
                    .catch(error => alert('Error: ' + error.message));
            }
        }

        function showExtractModal() {
            new bootstrap.Modal(document.getElementById('extractModal')).show();
        }

        function showClosePortfolioModal() {
            new bootstrap.Modal(document.getElementById('closePortfolioModal')).show();
        }

        function validateBalance() {
            // First check if we're in dry-run mode by getting current status
            fetch('api/status')
                .then(response => response.json())
                .then(statusData => {
                    if (statusData.dry_run_mode) {
                        // Show informational popup for dry-run mode
                        alert(`üß™ DRY-RUN MODE INFORMATION\\n\\n` +
                              `üìã Purpose of "Check Balance":\\n` +
                              `This button is designed for LIVE trading mode to validate your real Binance account balance.\\n\\n` +
                              `üîç In DRY-RUN mode:\\n` +
                              `‚Ä¢ No real balance validation needed\\n` +
                              `‚Ä¢ Robot uses virtual ${statusData.bnb_reserve || 100} BNB for simulation\\n` +
                              `‚Ä¢ No real money is at risk\\n` +
                              `‚Ä¢ All trades are simulated\\n\\n` +
                              `üí° When to use "Check Balance":\\n` +
                              `‚Ä¢ Before switching to LIVE mode (ROBOT_DRY_RUN=false)\\n` +
                              `‚Ä¢ To test your Binance API credentials\\n` +
                              `‚Ä¢ To verify real account funds for future live trading\\n\\n` +
                              `‚úÖ Your robot is ready to trade in simulation mode!`);
                        return;
                    }
                    
                    // In live mode, proceed with actual balance validation
                    performLiveBalanceValidation();
                })
                .catch(error => {
                    console.error('Error checking robot mode:', error);
                    // Fallback to live balance validation if status check fails
                    performLiveBalanceValidation();
                });
        }
        
        function performLiveBalanceValidation() {
            // Show loading state
            const originalText = event.target.innerHTML;
            event.target.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
            event.target.disabled = true;
            
            fetch('api/validate-balance')
                .then(response => response.json())
                .then(data => {
                    // Restore button
                    event.target.innerHTML = originalText;
                    event.target.disabled = false;
                    
                    if (data.success) {
                        const validation = data.validation_result;
                        const summary = data.balance_summary;
                        
                        let message = `üí∞ LIVE MODE BALANCE VALIDATION\\n\\n`;
                        message += `Reserve Asset: ${summary.reserve_asset}\\n`;
                        message += `Available Balance: ${summary.reserve_balance?.toFixed(6) || 0} ${summary.reserve_asset}\\n`;
                        message += `Required Amount: ${summary.required_amount} ${summary.reserve_asset}\\n`;
                        message += `Status: ${validation.is_valid ? '‚úÖ SUFFICIENT' : '‚ùå INSUFFICIENT'}\\n\\n`;
                        
                        if (validation.is_valid) {
                            message += `üöÄ Robot can start in LIVE mode!\\n`;
                            if (summary.reserve_status === 'low') {
                                message += `‚ö†Ô∏è  Balance is close to minimum - consider adding more funds.`;
                            }
                        } else {
                            message += `‚ùå Cannot start robot in LIVE mode:\\n`;
                            message += validation.message.replace(/\\n/g, '\\n');
                        }
                        
                        // Show other significant balances
                        if (summary.balances && Object.keys(summary.balances).length > 1) {
                            message += `\\n\\nüìä Other Assets:`;
                            Object.entries(summary.balances).forEach(([asset, info]) => {
                                if (asset !== summary.reserve_asset && info.total > 0) {
                                    message += `\\n${asset}: ${info.total.toFixed(6)}`;
                                }
                            });
                        }
                        
                        alert(message);
                    } else {
                        alert(`‚ùå Balance validation failed:\\n${data.message || data.error}`);
                    }
                })
                .catch(error => {
                    // Restore button
                    event.target.innerHTML = originalText;
                    event.target.disabled = false;
                    alert('Error checking balance: ' + error.message);
                });
        }

        // Toggle reset options visibility
        document.getElementById('enableReset').addEventListener('change', function() {
            const resetOptions = document.getElementById('resetOptions');
            if (this.checked) {
                resetOptions.style.display = 'block';
            } else {
                resetOptions.style.display = 'none';
            }
        });

        function executeClosePortfolio() {
            const confirmLiquidation = document.getElementById('confirmLiquidation').checked;
            const enableReset = document.getElementById('enableReset').checked;
            const newReserveAmount = document.getElementById('newReserveAmount').value;
            const autoStart = document.getElementById('autoStart').checked;
            const dryRun = document.getElementById('dryRunClose').checked;
            const resultDiv = document.getElementById('closePortfolioResult');
            const closeBtn = document.getElementById('closePortfolioBtn');
            
            if (!confirmLiquidation) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> You must confirm that you understand this will liquidate your entire portfolio.';
                resultDiv.style.display = 'block';
                return;
            }
            
            if (enableReset && (!newReserveAmount || parseFloat(newReserveAmount) < 0.01)) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Please enter a valid ' + BASE_ASSET + ' reserve amount (minimum 0.01 ' + BASE_ASSET + ').';
                resultDiv.style.display = 'block';
                return;
            }
            
            // Disable button and show loading
            closeBtn.disabled = true;
            closeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // Hide previous results
            resultDiv.style.display = 'none';
            
            const requestData = {
                confirm_liquidation: confirmLiquidation,
                reset_portfolio: enableReset,
                dry_run: dryRun
            };
            
            if (enableReset) {
                requestData.new_reserve_amount = parseFloat(newReserveAmount);
                requestData.auto_start = autoStart;
            }
            
            fetch('api/close-portfolio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                closeBtn.disabled = false;
                closeBtn.innerHTML = '<i class="fas fa-times-circle"></i> Close Portfolio';
                
                if (data.success) {
                    resultDiv.className = 'alert alert-success';
                    let summaryHtml = `
                        <h6><i class="fas fa-check-circle"></i> Portfolio Closure ${data.summary.dry_run ? 'Simulated' : 'Completed'}</h6>
                        <ul class="mb-0">
                            <li><strong>Total USDC Generated:</strong> ${data.summary.total_usdc_generated} USDC</li>
                            <li><strong>Positions Liquidated:</strong> ${data.summary.positions_liquidated}</li>
                            <li><strong>${BASE_ASSET} Reserve Converted:</strong> ${data.summary.bnb_converted} ${BASE_ASSET}</li>
                            <li><strong>Status:</strong> ${data.summary.dry_run ? 'Simulation Only' : 'Live Execution'}</li>
                    `;
                    
                    if (data.summary.reset_portfolio) {
                        summaryHtml += `
                            <li><strong>Portfolio Reset:</strong> Yes</li>
                            <li><strong>New ${BASE_ASSET} Reserve:</strong> ${data.summary.new_reserve_amount} ${BASE_ASSET}</li>
                            <li><strong>Auto-Start:</strong> ${data.summary.auto_start ? 'Yes' : 'No'}</li>
                        `;
                    }
                    
                    summaryHtml += '</ul>';
                    resultDiv.innerHTML = summaryHtml;
                    
                    if (!data.summary.dry_run) {
                        // Refresh status after live execution
                        setTimeout(refreshStatus, 2000);
                        
                        if (data.summary.reset_portfolio && data.summary.auto_start) {
                            // Show success message about restart
                            setTimeout(() => {
                                resultDiv.innerHTML += '<div class="alert alert-info mt-2"><i class="fas fa-info-circle"></i> Robot has been restarted with new configuration.</div>';
                            }, 3000);
                        }
                    }
                } else {
                    resultDiv.className = 'alert alert-danger';
                    const errors = data.errors || [data.error || 'Unknown error occurred'];
                    resultDiv.innerHTML = `
                        <h6><i class="fas fa-exclamation-triangle"></i> Portfolio Closure Failed</h6>
                        <ul class="mb-0">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    `;
                }
                
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                closeBtn.disabled = false;
                closeBtn.innerHTML = '<i class="fas fa-times-circle"></i> Close Portfolio';
                
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${error.message}`;
                resultDiv.style.display = 'block';
            });
        }

        function executeExtract() {
            const eurAmount = document.getElementById('eurAmount').value;
            const dryRun = document.getElementById('dryRun').checked;
            const resultDiv = document.getElementById('extractResult');
            const extractBtn = document.getElementById('extractBtn');
            
            if (!eurAmount || parseFloat(eurAmount) <= 0) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Please enter a valid EUR amount.';
                resultDiv.style.display = 'block';
                return;
            }
            
            // Disable button and show loading
            extractBtn.disabled = true;
            extractBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // Hide previous results
            resultDiv.style.display = 'none';
            
            fetch('api/extract', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    eur_amount: parseFloat(eurAmount),
                    dry_run: dryRun
                })
            })
            .then(response => response.json())
            .then(data => {
                extractBtn.disabled = false;
                extractBtn.innerHTML = '<i class="fas fa-play"></i> Execute Extract';
                
                if (data.success) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `
                        <h6><i class="fas fa-check-circle"></i> Extract Operation ${data.summary.dry_run ? 'Simulated' : 'Completed'}</h6>
                        <ul class="mb-0">
                            <li><strong>EUR Amount:</strong> ‚Ç¨${data.summary.eur_amount}</li>
                            <li><strong>${BASE_ASSET} Collected:</strong> ${data.summary.bnb_collected.toFixed(6)} ${BASE_ASSET}</li>
                            <li><strong>USDC Received:</strong> ${data.summary.usdc_received.toFixed(6)} USDC</li>
                            <li><strong>Positions Sold:</strong> ${data.summary.positions_sold}</li>
                            <li><strong>Status:</strong> ${data.summary.dry_run ? 'Simulation Only' : 'Live Execution'}</li>
                        </ul>
                    `;
                    
                    if (!data.summary.dry_run) {
                        // Refresh status after live execution
                        setTimeout(refreshStatus, 2000);
                    }
                } else {
                    resultDiv.className = 'alert alert-danger';
                    const errors = data.errors || [data.error || 'Unknown error occurred'];
                    resultDiv.innerHTML = `
                        <h6><i class="fas fa-exclamation-triangle"></i> Extract Operation Failed</h6>
                        <ul class="mb-0">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    `;
                }
                
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                extractBtn.disabled = false;
                extractBtn.innerHTML = '<i class="fas fa-play"></i> Execute Extract';
                
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${error.message}`;
                resultDiv.style.display = 'block';
            });
        }

        function showInjectModal() {
            // Load USDC balance when modal opens
            refreshUsdcBalance();
            new bootstrap.Modal(document.getElementById('injectModal')).show();
        }

        function refreshUsdcBalance() {
            const balanceInput = document.getElementById('usdcBalance');
            balanceInput.value = 'Loading...';
            
            fetch('api/usdc-balance')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        balanceInput.value = `${data.usdc_balance.toFixed(6)} USDC`;
                        
                        // Store balance for validation
                        window.availableUsdcBalance = data.usdc_balance;
                    } else {
                        balanceInput.value = 'Error loading balance';
                        console.error('Error loading USDC balance:', data.error);
                    }
                })
                .catch(error => {
                    balanceInput.value = 'Error loading balance';
                    console.error('Error loading USDC balance:', error);
                });
        }

        function executeInject() {
            const usdcAmount = document.getElementById('usdcAmount').value;
            const dryRun = document.getElementById('injectDryRun').checked;
            const resultDiv = document.getElementById('injectResult');
            const injectBtn = document.getElementById('injectBtn');
            
            if (!usdcAmount || parseFloat(usdcAmount) <= 0) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Please enter a valid USDC amount.';
                resultDiv.style.display = 'block';
                return;
            }
            
            // Check if amount exceeds available balance
            const requestedAmount = parseFloat(usdcAmount);
            if (window.availableUsdcBalance && requestedAmount > window.availableUsdcBalance) {
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> 
                    Insufficient USDC balance. 
                    Requested: ${requestedAmount.toFixed(6)} USDC, 
                    Available: ${window.availableUsdcBalance.toFixed(6)} USDC
                `;
                resultDiv.style.display = 'block';
                return;
            }
            
            // Disable button and show loading
            injectBtn.disabled = true;
            injectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // Hide previous results
            resultDiv.style.display = 'none';
            
            fetch('api/inject', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    usdc_amount: requestedAmount,
                    dry_run: dryRun
                })
            })
            .then(response => response.json())
            .then(data => {
                injectBtn.disabled = false;
                injectBtn.innerHTML = '<i class="fas fa-play"></i> Execute Inject';
                
                if (data.success) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `
                        <h6><i class="fas fa-check-circle"></i> Inject Operation ${data.summary.dry_run ? 'Simulated' : 'Completed'}</h6>
                        <ul class="mb-0">
                            <li><strong>USDC Amount:</strong> ${data.summary.usdc_amount.toFixed(6)} USDC</li>
                            <li><strong>USDC Converted:</strong> ${data.summary.usdc_converted.toFixed(6)} USDC</li>
                            <li><strong>${BASE_ASSET} Distributed:</strong> ${data.summary.bnb_distributed.toFixed(6)} ${BASE_ASSET}</li>
                            <li><strong>Positions Enhanced:</strong> ${data.summary.positions_enhanced}</li>
                            <li><strong>Status:</strong> ${data.summary.dry_run ? 'Simulation Only' : 'Live Execution'}</li>
                        </ul>
                    `;
                    
                    if (!data.summary.dry_run) {
                        // Refresh status and USDC balance after live execution
                        setTimeout(() => {
                            refreshStatus();
                            refreshUsdcBalance();
                        }, 2000);
                    }
                } else {
                    resultDiv.className = 'alert alert-danger';
                    const errors = data.errors || [data.error || 'Unknown error occurred'];
                    resultDiv.innerHTML = `
                        <h6><i class="fas fa-exclamation-triangle"></i> Inject Operation Failed</h6>
                        <ul class="mb-0">
                            ${errors.map(error => `<li>${error}</li>`).join('')}
                        </ul>
                    `;
                }
                
                resultDiv.style.display = 'block';
            })
            .catch(error => {
                injectBtn.disabled = false;
                injectBtn.innerHTML = '<i class="fas fa-play"></i> Execute Inject';
                
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error: ${error.message}`;
                resultDiv.style.display = 'block';
            });
        }

        function refreshConfiguration() {
            console.log('üîß Loading configuration...');
            
            // Show loading state
            document.getElementById('robot-config').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            document.getElementById('trading-config').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            document.getElementById('system-config').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            document.getElementById('database-config').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            
            fetch('api/config')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayConfiguration(data.config);
                    } else {
                        const errorMsg = `<span class="text-danger">Error: ${data.error}</span>`;
                        document.getElementById('robot-config').innerHTML = errorMsg;
                        document.getElementById('trading-config').innerHTML = errorMsg;
                        document.getElementById('system-config').innerHTML = errorMsg;
                        document.getElementById('database-config').innerHTML = errorMsg;
                    }
                })
                .catch(error => {
                    console.error('Error loading configuration:', error);
                    const errorMsg = `<span class="text-danger">Error: ${error.message}</span>`;
                    document.getElementById('robot-config').innerHTML = errorMsg;
                    document.getElementById('trading-config').innerHTML = errorMsg;
                    document.getElementById('system-config').innerHTML = errorMsg;
                    document.getElementById('database-config').innerHTML = errorMsg;
                });
        }

        function displayConfiguration(config) {
            // Robot Settings
            const robotSettings = [];
            const robotKeys = ['ROBOT_STATUS', 'ROBOT_DRY_RUN', 'CYCLE_DURATION', '_COMPUTED_CYCLE_HOURS', 'PORTFOLIO_SIZE'];
            robotKeys.forEach(key => {
                if (config[key] !== undefined) {
                    const displayKey = key.replace('_COMPUTED_', '').replace(/_/g, ' ');
                    robotSettings.push(`${displayKey}: <strong>${config[key]}</strong>`);
                }
            });
            document.getElementById('robot-config').innerHTML = robotSettings.join('<br>') || 'No robot settings found';

            // Trading Settings
            const tradingSettings = [];
            const tradingKeys = ['TRADING_FEE', 'TRADING_STRATEGY', 'ALLOCATION_PERCENTAGE', '_COMPUTED_ALLOCATION_PERCENT', 
                               'MIN_RESERVE_LIMIT', 'MIN_BALANCE_REQUIRED', 'USE_DIRECT_SWAPS', 'SWAP_FEE'];
            tradingKeys.forEach(key => {
                if (config[key] !== undefined) {
                    const displayKey = key.replace('_COMPUTED_', '').replace(/_/g, ' ');
                    tradingSettings.push(`${displayKey}: <strong>${config[key]}</strong>`);
                }
            });
            document.getElementById('trading-config').innerHTML = tradingSettings.join('<br>') || 'No trading settings found';

            // System Settings
            const systemSettings = [];
            const systemKeys = ['FLASK_DEBUG', 'FLASK_ENV', 'FLASK_PORT', 'FLASK_HOST', 'DOMAIN_NAME', 'USE_HTTPS'];
            systemKeys.forEach(key => {
                if (config[key] !== undefined) {
                    const displayKey = key.replace(/_/g, ' ');
                    systemSettings.push(`${displayKey}: <strong>${config[key]}</strong>`);
                }
            });
            document.getElementById('system-config').innerHTML = systemSettings.join('<br>') || 'No system settings found';

            // Database Settings
            const databaseSettings = [];
            const databaseKeys = ['DATABASE_TYPE', 'ENABLE_WAL_MODE', 'ENABLE_TRANSACTIONS'];
            databaseKeys.forEach(key => {
                if (config[key] !== undefined) {
                    const displayKey = key.replace(/_/g, ' ');
                    databaseSettings.push(`${displayKey}: <strong>${config[key]}</strong>`);
                }
            });
            document.getElementById('database-config').innerHTML = databaseSettings.join('<br>') || 'No database settings found';

            console.log('‚úÖ Configuration loaded successfully');
        }

        // Initialize - load data immediately
        console.log('=== PAGE INITIALIZATION ===');
        console.log('Starting immediate data load...');
        refreshStatus();
        
        // Load configuration on page load
        refreshConfiguration();

        // Auto-refresh every 15 seconds
        setInterval(refreshStatus, 15000);
    </script>
</body>
</html>
